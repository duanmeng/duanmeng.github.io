<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言该文档假定大家有一定的Docker基础，介绍了kubernetes的常用和重要的功能的简单使用方法，目的是为了让大家看完可以快速上手kubernetes，并且在遇到问题时或者想深入了解某方面的时候知道如何Google；该文档主要参考了https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;home&#x2F; 和 Kubernetes In Action">
<meta property="og:type" content="article">
<meta property="og:title" content="简明Kubernetes教程">
<meta property="og:url" content="http://example.com/2018/11/08/byte-of-kubernetes/index.html">
<meta property="og:site_name" content="Macduan Notes">
<meta property="og:description" content="前言该文档假定大家有一定的Docker基础，介绍了kubernetes的常用和重要的功能的简单使用方法，目的是为了让大家看完可以快速上手kubernetes，并且在遇到问题时或者想深入了解某方面的时候知道如何Google；该文档主要参考了https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;home&#x2F; 和 Kubernetes In Action">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://live.staticflickr.com/65535/52657735439_ecb8f37bc6_c.jpg">
<meta property="og:image" content="https://live.staticflickr.com/65535/52657900245_b55aef8af1_c.jpg">
<meta property="article:published_time" content="2018-11-08T06:55:19.000Z">
<meta property="article:modified_time" content="2023-04-10T01:57:29.779Z">
<meta property="article:author" content="duanmeng">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://live.staticflickr.com/65535/52657735439_ecb8f37bc6_c.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>简明Kubernetes教程</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/technology">Technology</a></li><!--
     --><!--
       --><li><a href="/categories/life">Life</a></li><!--
     --><!--
       --><li><a href="/archives/">Archives</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018/11/19/Eventually-Consistent%20-%20Revisited/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2018/08/24/epoll-notes/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/11/08/byte-of-kubernetes/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/11/08/byte-of-kubernetes/&text=简明Kubernetes教程"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/11/08/byte-of-kubernetes/&is_video=false&description=简明Kubernetes教程"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=简明Kubernetes教程&body=Check out this article: http://example.com/2018/11/08/byte-of-kubernetes/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/11/08/byte-of-kubernetes/&name=简明Kubernetes教程&description=&lt;h2 id=&#34;前言&#34;&gt;&lt;a href=&#34;#前言&#34; class=&#34;headerlink&#34; title=&#34;前言&#34;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;该文档假定大家有一定的Docker基础，介绍了kubernetes的常用和重要的功能的简单使用方法，目的是为了让大家看完可以快速上手kubernetes，并且在遇到问题时或者想深入了解某方面的时候知道如何Google；该文档主要参考了&lt;a href=&#34;https://kubernetes.io/docs/home/&#34;&gt;https://kubernetes.io/docs/home/&lt;/a&gt; 和 &lt;a href=&#34;https://item.jd.com/12510666.html&#34;&gt;Kubernetes In Action&lt;/a&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/11/08/byte-of-kubernetes/&t=简明Kubernetes教程"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">Kubernetes简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.</span> <span class="toc-text">kubernetes是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.</span> <span class="toc-text">kubernetes提供了什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E4%B8%8D%E6%8F%90%E4%BE%9B%E4%BB%80%E4%B9%88"><span class="toc-number">2.3.</span> <span class="toc-text">kubernetes不提供什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">kubernetes对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.1.</span> <span class="toc-text">基础对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E5%AF%B9%E8%B1%A1%EF%BC%88%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">2.4.2.</span> <span class="toc-text">高级对象（控制器）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%B5%81%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">架构与流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97"><span class="toc-number">3.</span> <span class="toc-text">操作指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">3.1.</span> <span class="toc-text">Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-restartPolicy"><span class="toc-number">3.1.1.</span> <span class="toc-text">Container restartPolicy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-Probes"><span class="toc-number">3.1.2.</span> <span class="toc-text">Container Probes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">3.2.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DaemonSet"><span class="toc-number">3.3.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment"><span class="toc-number">3.4.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">3.5.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%BB%99%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.5.1.</span> <span class="toc-text">服务暴露给集群内部客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">服务发现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%BB%99%E9%9B%86%E7%BE%A4%E5%A4%96%E9%83%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.5.2.</span> <span class="toc-text">服务暴露给集群外部客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap%E5%92%8CSecret"><span class="toc-number">3.6.</span> <span class="toc-text">ConfigMap和Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PV%E5%92%8CPVC"><span class="toc-number">3.7.</span> <span class="toc-text">PV和PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet"><span class="toc-number">3.8.</span> <span class="toc-text">StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97"><span class="toc-number">4.</span> <span class="toc-text">服务改造指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">检索服务</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        简明Kubernetes教程
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">duanmeng</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-11-08T06:55:19.000Z" itemprop="datePublished">2018-11-08</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/technology/">technology</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Cloud/" rel="tag">Cloud</a>, <a class="tag-link-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该文档假定大家有一定的Docker基础，介绍了kubernetes的常用和重要的功能的简单使用方法，目的是为了让大家看完可以快速上手kubernetes，并且在遇到问题时或者想深入了解某方面的时候知道如何Google；该文档主要参考了<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a> 和 <a target="_blank" rel="noopener" href="https://item.jd.com/12510666.html">Kubernetes In Action</a><span id="more"></span>。</p>
<h2 id="Kubernetes简介"><a href="#Kubernetes简介" class="headerlink" title="Kubernetes简介"></a>Kubernetes简介</h2><h3 id="kubernetes是什么"><a href="#kubernetes是什么" class="headerlink" title="kubernetes是什么"></a>kubernetes是什么</h3><p>kubernetes源自google内部的<a target="_blank" rel="noopener" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/43438.pdf">Borg</a>和<a target="_blank" rel="noopener" href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41684.pdf">Omega</a>的开源软件系统，允许在它上面部署和管理容器的应用。它将底层基础设施抽象，使得在大规模的服务器（VM或BM）节点上运行软件就像在单个节点上运行一样，简化了开发，部署和运维。</p>
<h3 id="kubernetes提供了什么"><a href="#kubernetes提供了什么" class="headerlink" title="kubernetes提供了什么"></a>kubernetes提供了什么</h3><ul>
<li>服务发现与负载均衡</li>
<li>自动部署，扩容，回滚和自愈</li>
<li>存储编排（本地，云），配置和加密配置管理</li>
<li>自动装箱</li>
</ul>
<h3 id="kubernetes不提供什么"><a href="#kubernetes不提供什么" class="headerlink" title="kubernetes不提供什么"></a>kubernetes不提供什么</h3><ul>
<li><p>不能源码部署和应用构建</p>
</li>
<li><p>不提供应用层服务，比如Kafka，Spark，MySQL，Redis等</p>
</li>
<li><p>不提供应用的日志，监控和告警解决方案</p>
</li>
<li><p>不提供机器配置，维护，管理或自我修复系统</p>
</li>
</ul>
<h3 id="kubernetes对象"><a href="#kubernetes对象" class="headerlink" title="kubernetes对象"></a>kubernetes对象</h3><p>Kubernetes Objects是Kubernetes系统中的持久化的实体（etcd中）。 Kubernetes使用这些实体来表示集群的状态：</p>
<ul>
<li>在哪个节点上运行什么样的容器化应用</li>
<li>这些 应用能获取的资源</li>
<li>这些应用重启，升级和容错的策略</li>
</ul>
<p>通过创建对象告知kubernetes系统想要达到的状态，然后系统会保证向这个状态收敛，比如副本数量。</p>
<h4 id="基础对象"><a href="#基础对象" class="headerlink" title="基础对象"></a>基础对象</h4><ul>
<li>Pod，基础的执行，调度和部署单元</li>
<li>Service， 暴露一组Pods到网络的抽象</li>
<li>Volume，持久化存储和容器间共享存储的抽象</li>
</ul>
<h4 id="高级对象（控制器）"><a href="#高级对象（控制器）" class="headerlink" title="高级对象（控制器）"></a>高级对象（控制器）</h4><ul>
<li>ReplicaSet，一组Pods的副本</li>
<li>Deployment，为Pods和ReplicaSet提供声明式更新</li>
<li>Statefulset，管理有状态应用的workload API</li>
<li>DaemonSet，保证每个node上都有一个pod的replica</li>
</ul>
<h3 id="架构与流程"><a href="#架构与流程" class="headerlink" title="架构与流程"></a>架构与流程</h3><p>如下图所示，kubernetes集群包含两部分，控制面（或者叫Master）和工作节点（Workers）：</p>
<p><strong>控制面</strong></p>
<ul>
<li>API服务器</li>
<li>控制器</li>
<li>调度器</li>
<li>etcd</li>
</ul>
<p><strong>工作节点</strong></p>
<ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>容器运行时</li>
</ul>
<p>用户将镜像推送到镜像仓库之后，通过控制面发送API服务器部署请求（或者命令行），控制器收到API服务器通知后创建服务部署的对象（Deployment，Pods的元数据存储在etcd中，后面会详细描述），最后API服务器向调度器发送通知，调度器选择合适的工作节点后，API服务器通知选中的节点通过kubelet创建Pod和其中的Containers。</p>
<p><a><img src="https://live.staticflickr.com/65535/52657735439_ecb8f37bc6_c.jpg" width="800" height="319" alt="k8s-cp"></a></p>
<p><a ><img src="https://live.staticflickr.com/65535/52657900245_b55aef8af1_c.jpg" width="800" height="508" alt="k8s-mgr"></a></p>
<h2 id="操作指南"><a href="#操作指南" class="headerlink" title="操作指南"></a>操作指南</h2><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod是kubernetes的基本构建模块，它是一组并置的容器，但比较常见的是一个pod只包含一个容器，kubernetes集群中的所有pod都在同一个共享网络空间中（无NAT平坦网络），使用kubernetes的开发者面对的最底层的不再是VM或BM而且pod这个逻辑主机。</p>
<p>kubernetes都是通过YAML文件描述pod等对象，一个典型的pod的yaml文件如下所示，包含4个部分：</p>
<ul>
<li>apiVersion</li>
<li>kind，这个yaml文件要描述的对象的类型</li>
<li>metadata，pod的名字，标签等</li>
<li>spec，在pod的yaml文件中spec是描述容器的部分</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">container-demo</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接通过yaml文件创建pod</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pod]# kubectl create -f pod-nginx.yaml </span><br><span class="line">pod/pod-demo created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pod会发现一个名字为pod-demo的pod正在运行</span></span><br><span class="line">[root@VM_2_15_centos ~]# kubectl get pod pod-demo -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE       NOMINATED NODE</span><br><span class="line">pod-demo   1/1     Running   0          19h   192.168.0.34   10.1.2.6   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong>会发现在10.1.2.15上创建的pod，最终被调度到10.1.2.6这个Node上，在10.1.2.2上起一个临时的pod，直接向pod-demo中的nginx服务发请求</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在另一台Node上启一个临时的pod, 发送curl命令测试</span></span><br><span class="line">[root@VM_2_2_centos ~]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://192.168.0.34</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在10.1.2.6上观察可以看到临时curlutils pod被调度到10.1.2.15上, 经过了Pending, ContainerCreating和Terminating几个状态</span></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide --watch</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE</span><br><span class="line">pod-demo                            1/1     Running   0          19h   192.168.0.34   10.1.2.6    &lt;none&gt;</span><br><span class="line">curlutils   0/1   Pending   0     0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">curlutils   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">curlutils   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">curlutils   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">curlutils   0/1   Completed   0     2s    192.168.2.53   10.1.2.15   &lt;none&gt;</span><br><span class="line">curlutils   0/1   Terminating   0     2s    192.168.2.53   10.1.2.15   &lt;none&gt;</span><br><span class="line">curlutils   0/1   Terminating   0     3s    192.168.2.53   10.1.2.15   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>通过<code>kubectl get pod pod-demo -o yaml</code>可以看到具体的pod的详细信息，同时也会发现多一个status部分描述了这个pod的状态，这就是前面<em>kubernetes对象</em>提到的对象期望的状态和kubernetes向这个期望收敛的情况。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/pod]# kubectl get pod pod-demo -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: container-demo</span><br><span class="line">   ...</span><br><span class="line">  terminationGracePeriodSeconds: 30</span><br><span class="line">  volumes:</span><br><span class="line">  - name: default-token-n6snk</span><br><span class="line">    secret:</span><br><span class="line">      defaultMode: 420</span><br><span class="line">      secretName: default-token-n6snk</span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  ...</span><br><span class="line">  containerStatuses:</span><br><span class="line">  - containerID: </span><br><span class="line">    ...</span><br><span class="line">    image: nginx:latest</span><br><span class="line">    ...</span><br><span class="line">    name: container-demo</span><br><span class="line">  hostIP: 10.1.2.6</span><br><span class="line">  phase: Running</span><br><span class="line">  podIP: 192.168.0.34</span><br><span class="line">  qosClass: BestEffort</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是Pod中的容器（应用实例）crash了只会原地重启，Pod本身不会被调度，只有由于Node的原因或者Pod被删除了Pod才会被重新调度，在某个节点重新被创建。</strong>Pod的详细介绍请参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">这里</a>。</p>
<h4 id="Container-restartPolicy"><a href="#Container-restartPolicy" class="headerlink" title="Container restartPolicy"></a>Container restartPolicy</h4><p>Pod可以通过PodSpec(yaml文件中的Pod.spec.restartPolicy)设置Pod中的所有的containers的重启策略：</p>
<ul>
<li>Always，默认设置，不管Container是成功退出(exit 0)，还是错误退出</li>
<li>OnFailure，只有非成功退出时才会重启</li>
<li>Never，从不重启</li>
</ul>
<p><em>我们开发的绝大多数是一直运行的服务，所以推荐使用Always策略。</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@VM_2_15_centos</span> <span class="string">~/macduan/demo/pod</span>]<span class="comment"># cat pod-lifecycle.pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">lc-demo</span> </span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;sleep 5&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pod]# kubectl get pod pod-demo -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">  labels:</span><br><span class="line">    app: demo</span><br><span class="line">  name: pod-demo</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    ...</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: lc-demo</span><br><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>用上述yaml文件创建一个pod，该Pod中的Container运行5s会正常退出，<code>kubectl get pod pod-demo -o yaml</code>可以看出默认的restartPolicy是Always，<code>kubectl get pod -o wide -l app=demo --watch</code>可以看到Pod的状态的变化，第一次Container退出后处于Completed状态后马上重启处于running状态，之后每次Complete之后会先进入CrashLoopBackOff。</p>
<p>CrashLoopBackOff策略是第一次马上重启，第二在10s之后，第三次开始每次等待时间是20s，40s指数增长直到160s，最后稳定在等待300s重启一次。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide -l app=demo --watch</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE</span><br><span class="line">pod-demo   0/1     Pending   0          0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   0     5s    192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   0     10s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   1     11s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   1     17s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   1     30s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   2     32s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   2     37s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   2     50s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   3     66s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   3     71s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   3     82s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   4     2m6s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   4     2m11s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   4     2m26s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   5     3m35s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   5     3m40s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   5     3m54s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   6     6m30s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   6     6m35s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   6     6m47s   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   7     11m   192.168.2.118   10.1.2.15   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>如果设置重启策略为OnFailure就会发现Container退出后没有没有重启。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pod]# cat pod-lifecycle.pod </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  labels:</span><br><span class="line">    app: demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx </span><br><span class="line">    name: lc-demo </span><br><span class="line">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;sleep 5&#x27;]</span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line"></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide -l app=demo --watch</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE</span><br><span class="line">pod-demo   0/1     Pending   0          0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   0     2s    192.168.2.119   10.1.2.15   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Completed   0     7s    192.168.2.119   10.1.2.15   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>如果修改yaml文件，让Container错误退出<code>exit</code> 1<code>，会发现Pod的状态变化和前面</code>Always&#96;时很类似，只是Pod在Container错误退出后是进入Error状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pod]# cat pod-lifecycle.pod </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  labels:</span><br><span class="line">    app: demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx </span><br><span class="line">    name: lc-demo </span><br><span class="line">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;sleep 5 &amp;&amp; exit 1&#x27;]</span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line"></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide -l app=demo --watch</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE</span><br><span class="line">pod-demo   0/1     Pending   0          0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   0     2s    192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Error   0     7s    192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   1     8s    192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Error   1     13s   192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   1     28s   192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   2     30s   192.168.1.82   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Error   2     35s   192.168.1.82   10.1.2.2   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Container-Probes"><a href="#Container-Probes" class="headerlink" title="Container Probes"></a>Container Probes</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes">Probe是通过Kubelet对容器进行的一种诊断</a>，我们还可以对Container设置以下3种探针：</p>
<ul>
<li>livenessProbe，探测该容器是否存活，适用于服务未退出但是工作不正常的场景。</li>
<li>readinessProbe，探测该容器是否可以提供服务，适用于不希望初始化未成功（比如加载索引，配置）的容器提供服务的场景。</li>
<li>startupProbe，探测该容器是否启动成功，适用于对启动成功有限制条件的场景，如果设置了该探针，前两个探针会被disable直到该探针返回成功。</li>
</ul>
<p>以上三个探针如果未设置默认返回都是成功，如果失败则受制于上一节描述的restartPolicy。Probe的设置方式有：<code>ExecAction</code>，<code>TCPSocketAction</code>和<code>HTTPGetAction</code>，详细的设置包括探测延迟，探测间隔等可以参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Configure Liveness, Readiness and Startup Probes</a>，下面只给出使用HTTPGetAction方式的livenessProbe的例子：<br>在PodSpec.containers.livenessProbe中故意使用一个无效的port，会发现Pod的状态的变化和上一节描述<code>Always</code>重启策略时很像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pod]# cat pod-lifecycle.pod </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  labels:</span><br><span class="line">    app: demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx </span><br><span class="line">    name: lc-demo </span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /</span><br><span class="line">        port: 8090</span><br><span class="line">      initialDelaySeconds: 3</span><br><span class="line">      periodSeconds: 3</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">  </span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide -l app=demo --watch</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE</span><br><span class="line">pod-demo   0/1     Pending   0          0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   0     3s    192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   1     13s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   2     25s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   3     37s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   3     49s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   4     73s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   4     85s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   5     2m17s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   5     2m27s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   6     3m49s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   6     4m    192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   7     6m50s   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   0/1   CrashLoopBackOff   7     7m    192.168.1.83   10.1.2.2   &lt;none&gt;</span><br><span class="line">pod-demo   1/1   Running   8     12m   192.168.1.83   10.1.2.2   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h3><p>ReplicaSet主要用于副本控制（比如，设置副本数为3，保证副本有且仅有3份）和Pod异常时重新调度，上一节提到的Pod被删除后会被重新调度就是ReplicaSet做的事情。</p>
<p>在ReplicaSet的yaml文件一样也有spec部分描述想要达到的状态，特别是副本数量；它的Pod的描述在template部分。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rs-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container-demo</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>这里用<code>kubectl apply</code>而不是之前的<code>kubectl create</code>，是因为<code>kubectl apply</code>属于<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/">Declarative Management</a>，<code>kubectl create</code>属于<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/imperative-config/">Imperative Management</a> ，Declarative的方式<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47369351/kubectl-apply-vs-kubectl-create">可追踪的增量变更</a>，两种方式<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/">不可混用</a>不然会产生未定义行为。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建ReplicaSet</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/rs]# kubectl apply -f rs-demo.yaml </span><br><span class="line">replicaset.apps/rs-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/rs]# kubectl get rs rs-demo -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   READY   AGE   CONTAINERS       IMAGES   SELECTOR</span><br><span class="line">rs-demo   2         0         0       10s   container-demo   nginx    app=nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现创建了2个Pod, 名字都是yaml文件中设置的pod-demo开头, 被调度到另外2个节点上了</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/rs]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP             NODE       NOMINATED NODE</span><br><span class="line">rs-demo-lk277   1/1     Running   0          23s   192.168.0.50   10.1.2.6   &lt;none&gt;</span><br><span class="line">rs-demo-p5q5p   1/1     Running   0          23s   192.168.1.43   10.1.2.2   &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在2台不同的节点上可以看到Pod的container进程</span></span><br><span class="line">[root@VM_2_2_centos ~]# docker container ls -f name=container</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">cbc23e5b9f3c        nginx               &quot;nginx -g &#x27;daemon of…&quot;   About an hour ago   Up About an hour                        k8s_container-demo_rs-demo-lk277_default_b1e17f82-d506-11e9-91dd-8a673d1f8ffc_0</span><br><span class="line"></span><br><span class="line">[root@VM_2_6_centos ~]# docker container ls -f name=container</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">17e153df5c9f        nginx               &quot;nginx -g &#x27;daemon of…&quot;   About an hour ago   Up About an hour                        k8s_container-demo_pod-demo_default_6c0b3042-d526-11e9-91dd-8a673d1f8ffc_0</span><br></pre></td></tr></table></figure>

<p>ReplicaSet（rs-demo）设置了2个replica，所以上面可以看到有2个Pod，都是rs-demo后面加上随机字符串，如果删除其中一个pod，ReplicaSet会启动一个新的Pod，从下面代码可以看出，删除rs-demo-lk277后拉起了一个新的Pod（rs-demo-cj5p5），replica数量恢复到2个了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_6_centos ~]# kubectl delete pod rs-demo-lk277</span><br><span class="line">pod &quot;rs-demo-lk277&quot; deleted</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~]# kubectl get pod -o wide -l app=nginx --watch</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE</span><br><span class="line">rs-demo-lk277   1/1     Running   0          5h53m   192.168.1.49   10.1.2.2    &lt;none&gt;</span><br><span class="line">rs-demo-p5q5p   1/1     Running   0          5h53m   192.168.2.69   10.1.2.15   &lt;none&gt;</span><br><span class="line">rs-demo-lk277   1/1   Terminating   0     5h54m   192.168.1.49   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-cj5p5   0/1   Pending   0     0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">rs-demo-cj5p5   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-cj5p5   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-lk277   0/1   Terminating   0     5h54m   192.168.1.49   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-cj5p5   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-lk277   0/1   Terminating   0     5h54m   192.168.1.49   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-lk277   0/1   Terminating   0     5h54m   192.168.1.49   10.1.2.2   &lt;none&gt;</span><br><span class="line">rs-demo-cj5p5   1/1   Running   0     5s    192.168.1.50   10.1.2.2   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>修改rs-demo的yaml文件中的replica参数为3后，执行<code>kubectl apply</code>会拉起一个新的Pod，rs-demo的状态也在变化。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/rs]# kubectl apply -f rs-demo.yaml </span><br><span class="line">replicaset.apps/rs-demo configured</span><br><span class="line"></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get pod -o wide -l app=nginx --watch</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE</span><br><span class="line">rs-demo-cj5p5   1/1     Running   0          4m24s   192.168.1.50   10.1.2.2    &lt;none&gt;</span><br><span class="line">rs-demo-p5q5p   1/1     Running   0          5h59m   192.168.2.69   10.1.2.15   &lt;none&gt;</span><br><span class="line">rs-demo-wxvkn   0/1   Pending   0     0s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><br><span class="line">rs-demo-wxvkn   0/1   Pending   0     0s    &lt;none&gt;   10.1.2.6   &lt;none&gt;</span><br><span class="line">rs-demo-wxvkn   0/1   ContainerCreating   0     0s    &lt;none&gt;   10.1.2.6   &lt;none&gt;</span><br><span class="line">rs-demo-wxvkn   0/1   ContainerCreating   0     1s    &lt;none&gt;   10.1.2.6   &lt;none&gt;</span><br><span class="line">rs-demo-wxvkn   1/1   Running   0     5s    192.168.0.55   10.1.2.6   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get rs rs-demo -o wide  --watch</span><br><span class="line">NAME      DESIRED   CURRENT   READY   AGE     CONTAINERS       IMAGES   SELECTOR</span><br><span class="line">rs-demo   2         2         2       5h59m   container-demo   nginx    app=nginx</span><br><span class="line">rs-demo   3     2     2     5h59m   container-demo   nginx   app=nginx</span><br><span class="line">rs-demo   3     2     2     5h59m   container-demo   nginx   app=nginx</span><br><span class="line">rs-demo   3     3     2     5h59m   container-demo   nginx   app=nginx</span><br><span class="line">rs-demo   3     3     3     5h59m   container-demo   nginx   app=nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以直接kubectl delete rs rs-demo删除, 但是推荐用kubectl delete -f &lt;filename&gt;的方式删除对象,删除ReplicaSet之后,所有的Pods也自动被删除</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/rs]# kubectl delete -f rs-demo.yaml </span><br><span class="line">replicaset.apps &quot;rs-demo&quot; deleted</span><br></pre></td></tr></table></figure>

<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>有时候需要在每个Node上正好运行一个Pod（比如监控），这时候就需要DaemonSet了，下面的yaml文件可以创一个DaemonSet。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ds-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.17.3</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cont-demo</span></span><br></pre></td></tr></table></figure>

<p>上面的yaml文件中没有指定，replica数量，但是创建成功之后发现在每个节点上都有<code>spec.template</code>部分描述的Pod被创建了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/daemonset]# kubectl apply -f demo-ds.yaml </span><br><span class="line">daemonset.apps/ds-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/daemonset]# kubectl get daemonset ds-demo -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">ds-demo   3         3         3       3            3           &lt;none&gt;          13s   cont-demo    nginx:1.17.3   app=nginx</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/daemonset]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP              NODE        NOMINATED NODE</span><br><span class="line">ds-demo-gsr4c   1/1     Running   0          23s   192.168.2.105   10.1.2.15   &lt;none&gt;</span><br><span class="line">ds-demo-lqptf   1/1     Running   0          23s   192.168.0.93    10.1.2.6    &lt;none&gt;</span><br><span class="line">ds-demo-qmdlt   1/1     Running   0          23s   192.168.1.67    10.1.2.2    &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deployment是一种高阶资源，以声明的方式部署和升级应用，其底层是一个或多个ReplicaSet。使用下面的yaml文件创建一个Deployment时，会发现自动创建了一个ReplicaSet和2个Pod。而Pod命名是一个RS的名字加一个随机字符串，RS名字中的那个字符串<code>65f7dfc8fb</code>实际是yaml文件中Pod描述部分的哈希值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.16.1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cont-demo</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl apply -f demo-deploy.yaml </span><br><span class="line">deployment.apps/dp-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl get deployment -o wide</span><br><span class="line">NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS         IMAGES                                                   SELECTOR</span><br><span class="line">dp-demo            2         2         2            2           14s   cont-demo          nginx:1.16.1                                             app=nginx</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl get rs -l app=nginx -o wide</span><br><span class="line">NAME                 DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">dp-demo-65f7dfc8fb   2         2         2       44s   cont-demo    nginx:1.16.1   app=nginx,pod-template-hash=65f7dfc8fb</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE</span><br><span class="line">dp-demo-65f7dfc8fb-6pn7p   1/1     Running   0          55s   192.168.2.72   10.1.2.15   &lt;none&gt;</span><br><span class="line">dp-demo-65f7dfc8fb-jlnmh   1/1     Running   0          55s   192.168.1.55   10.1.2.2    &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE</span><br><span class="line">dp-demo-65f7dfc8fb-6pn7p   1/1     Running   0          3m37s   192.168.2.72   10.1.2.15   &lt;none&gt;</span><br><span class="line">dp-demo-65f7dfc8fb-jlnmh   1/1     Running   0          3m37s   192.168.1.55   10.1.2.2    &lt;none&gt;</span><br><span class="line">dp-demo-65f7dfc8fb-lkxq2   1/1     Running   0          3s      192.168.0.58   10.1.2.6    &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>咋一看Deployment和RS区别不大，但是如果我们需要升级应用的时候（<strong>只有修改Pod的描述对Deployment来说才算升级</strong>），Deployment的作用就可以更好提现了。</p>
<p>我们将<code>demo-deploy.yaml</code>中的nginx版本从1.16.1改成1.17.1, 然后更新Deployment，更新完成之后发现新增了一个IMAGES为<code>nginx:1.17.1</code>的RS，老版本的RS<code>nginx:1.16.1</code>的Pod数量 变为0了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl apply -f demo-deploy.yaml --record</span><br><span class="line">deployment.apps/dp-demo configured</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get deployment -l app=nginx -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">dp-demo   2         2         2            2           109s   cont-demo    nginx:1.17.1   app=nginx</span><br><span class="line">[root@VM_2_2_centos ~]# kubectl get rs -l app=nginx -o wide </span><br><span class="line">NAME                 DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">dp-demo-65f7dfc8fb   0         0         0       96s   cont-demo    nginx:1.16.1   app=nginx,pod-template-hash=65f7dfc8fb</span><br><span class="line">dp-demo-85b846dd4f   2         2         2       19s   cont-demo    nginx:1.17.1   app=nginx,pod-template-hash=85b846dd4f</span><br></pre></td></tr></table></figure>

<p>前面提到过Deployment是更高级别的抽象，会管理多个版本，不仅可以滚动更新（默认模式，可以选择Recreate模式）还可以回滚或在各个版本之间切换。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到创建了两个版本</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl rollout history deployment dp-demo</span><br><span class="line">deployment.extensions/dp-demo </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         kubectl apply --filename=demo-deploy.yaml --record=true</span><br><span class="line">2         kubectl apply --filename=demo-deploy.yaml --record=true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接回滚</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl rollout undo deployment dp-demo</span><br><span class="line">deployment.extensions/dp-demo</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get deployment -l app=nginx -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">dp-demo   2         2         2            2           3m21s   cont-demo    nginx:1.16.1   app=nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到指定版本</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl rollout undo deployment dp-demo --to-revision=2</span><br><span class="line">deployment.extensions/dp-demo</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl get deployment -l app=nginx -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">dp-demo   2         2         2            2           4m8s   cont-demo    nginx:1.17.1   app=nginx</span><br></pre></td></tr></table></figure>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><h4 id="服务暴露给集群内部客户端"><a href="#服务暴露给集群内部客户端" class="headerlink" title="服务暴露给集群内部客户端"></a>服务暴露给集群内部客户端</h4><p>用如下yaml文件可以创建一个ClusterIP类型的服务，仅可以在集群内部访问。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">srv-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>创建完成之后发现，有一个TYPE为ClusterIP的service资源，分配了一个192.168.255.102的ip，其SELECTOR是app&#x3D;nginx，service控制器会持续扫描找到label与这个service的selector一致的pod关联（上一节创建的Pod）。通过分配的虚拟ip，请求被转发到后面的某个Pod上的nginx服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl apply -f srv-demo.yaml </span><br><span class="line">service/srv-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get svc srv-demo -o wide</span><br><span class="line">NAME       TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)   AGE    SELECTOR</span><br><span class="line">srv-demo   ClusterIP   192.168.255.102   &lt;none&gt;        80/TCP    104s   app=nginx</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://192.168.255.102</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上文提到的关联实际是通过Endpoint</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get endpoints srv-demo</span><br><span class="line">NAME       ENDPOINTS                                         AGE</span><br><span class="line">srv-demo   192.168.0.76:80,192.168.1.61:80,192.168.2.81:80   3h28m</span><br></pre></td></tr></table></figure>

<p>上面提到的Service与Pods<strong>关联</strong>，本质就是Service知道它背后支持它的Pods的ip和port，这是通过Endpoints实现的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl describe svc srv-demo</span><br><span class="line">Name:              srv-demo</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;srv-demo&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;ports&quot;:[&#123;&quot;port&quot;:80,&quot;tar...</span><br><span class="line">Selector:          app=nginx</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                192.168.255.102</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         192.168.0.76:80,192.168.1.61:80,192.168.2.81:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get endpoints srv-demo</span><br><span class="line">NAME       ENDPOINTS                                         AGE</span><br><span class="line">srv-demo   192.168.0.76:80,192.168.1.61:80,192.168.2.81:80   3h28m</span><br></pre></td></tr></table></figure>



<h5 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h5><p>看完上面的过程会发现一个问题，集群内部的客户端要访问这个服务必须知道<em>192.168.255.102</em>， 那如何获取呢？有两种方式：</p>
<ul>
<li><p>环境变量，如果客户端Pod创建晚于这个Service，那么这个Pod就会有这个Service的IP和PORT的环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl exec dp-demo-56d95d4c95-xzzc7 env | grep SRV_DEMO</span><br><span class="line">SRV_DEMO_PORT_80_TCP=tcp://192.168.255.102:80</span><br><span class="line">SRV_DEMO_PORT_80_TCP_ADDR=192.168.255.102</span><br><span class="line">SRV_DEMO_SERVICE_HOST=192.168.255.102</span><br><span class="line">SRV_DEMO_SERVICE_PORT=80</span><br><span class="line">SRV_DEMO_PORT=tcp://192.168.255.102:80</span><br><span class="line">SRV_DEMO_PORT_80_TCP_PROTO=tcp</span><br><span class="line">SRV_DEMO_PORT_80_TCP_PORT=80</span><br></pre></td></tr></table></figure>
</li>
<li><p>DNS，环境变量获取方式有其局限性，Kubernetes其内部DNS服务使客户端Pod可以通过<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a>来访问（前提是知道服务的名称），FQDN格式为<code>service_name.[$namespace].[svc].[local]</code>，但是Service的端口号如果不是标准的，客户端Pod必须提前知道</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://srv-demo.default.svc.cluster.local</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl http://srv-demo.default.svc.cluster.local</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl http://srv-demo.default</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl http://srv-demo</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面这三种方式都可以</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="服务暴露给集群外部客户端"><a href="#服务暴露给集群外部客户端" class="headerlink" title="服务暴露给集群外部客户端"></a>服务暴露给集群外部客户端</h4><p>有三种方式可以将服务暴露给集群外部客户端：</p>
<ul>
<li>NodePort，在<strong>所有</strong>Node上打开一个端口，客户端向其中任何一个Node的该端口发送的请求都会被Service重定向到其背后某个Pod的应用的端口上。</li>
<li>LoadBalance，是NodePort的扩展，会自动分配Node上的一个端口，创建CLB（腾讯云TKE会默认创建一个CLB），<strong>本质上是一个NodePort方式</strong>，只是端口是随机分配，CLB自动创建。</li>
<li>Ingress，使用一个公网IP公开多个服务，详细请见<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">这里</a></li>
</ul>
<p>下面这个manifest是创建一个NodePort服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@VM_2_15_centos</span> <span class="string">~/macduan/demo/service</span>]<span class="comment"># cat svc-np-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-np-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31135</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>创建完成之后发现，分配了一个Cluster-IP，通过这个ip或者FQDN访问该服务都ClusterIP类型的服务类似，这里多了一个<code>NodePort 31135</code>，虽然Pods只被调度到10.1.2.2和10.1.2.15两个Node上，但是在10.1.2.6上发现31135也是被打开了，在上面发送请求也会被Service重定向到10.1.2.2和10.1.2.15上的某个Pod上。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl apply -f svc-np-demo.yaml </span><br><span class="line">service/svc-np-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get svc svc-np-demo -o wide</span><br><span class="line">NAME          TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">svc-np-demo   NodePort   192.168.255.96   &lt;none&gt;        80:31135/TCP   16s   app=nginx</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE</span><br><span class="line">dp-demo-56d95d4c95-tss5j   1/1     Running   0          4h18m   192.168.1.61   10.1.2.2    &lt;none&gt;</span><br><span class="line">dp-demo-56d95d4c95-xzzc7   1/1     Running   0          4h18m   192.168.2.81   10.1.2.15   &lt;none&gt;</span><br><span class="line">[root@VM_2_6_centos ~]# curl localhost:31135</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>下面这个manifest创建一个LoadBalance类型服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@VM_2_15_centos</span> <span class="string">~/macduan/demo/service</span>]<span class="comment"># cat svc-lb-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-lb-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>创建完成之后发现，自动创建了CLB并且分配了一个外网IP<code>192.144.195.158</code>，外部客户端也可以访问该服务了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl apply -f svc-lb-demo.yaml </span><br><span class="line">service/svc-lb-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get svc svc-lb-demo </span><br><span class="line">NAME          TYPE           CLUSTER-IP        EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">svc-lb-demo   LoadBalancer   192.168.255.250   &lt;pending&gt;     80:31134/TCP   8s</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/service]# kubectl get svc svc-lb-demo</span><br><span class="line">NAME          TYPE           CLUSTER-IP        EXTERNAL-IP       PORT(S)        AGE</span><br><span class="line">svc-lb-demo   LoadBalancer   192.168.255.250   192.144.195.158   80:31134/TCP   2m45s</span><br><span class="line">[root@VM_9_103_centos~]</span><br><span class="line">$ curl http://192.144.195.158</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="ConfigMap和Secret"><a href="#ConfigMap和Secret" class="headerlink" title="ConfigMap和Secret"></a>ConfigMap和Secret</h3><p>一般应用都会需要配置项，kubernetes提供了ConfigMap和Secret两种资源对象。ConfigMap可以通过字符串，文件或文件的方式创建，使用文件的方式创建的ConfigMap的key就是文件名，value就是文件内容，那么通过文件夹创建的就是批量文件创建方式。</p>
<p>创建一个文件，并通过文件方式创建一个ConfigMap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/configmap]# cat index.html </span><br><span class="line">&lt;h&gt;&quot;Hello World!&quot;&lt;/h&gt;</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/configmap]# kubectl create configmap cfm-demo --from-file=index.html</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/configmap]# kubectl get configmap cfm-demo -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  index.html: |</span><br><span class="line">    &lt;h&gt;&quot;Hello World!&quot;&lt;/h&gt;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">  name: cfm-demo</span><br><span class="line">  namespace: default</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>我们可以修改Deployment的Pod模板部分，通过volumes和volumeMount使用创建的ConfigMap</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-cfm-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.17.3</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cont-demo</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cfm-demo</span></span><br></pre></td></tr></table></figure>

<p>上述yaml文件中，将ConfigMap cfm-demo挂载（覆盖）了容器<code>/usr/share/nginx/html</code>目录，使用上面的yaml文件创建一个Deployment之后，发现向其中的Pod发送请求收到的内容变成生存cfm-demo的文件的内容了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/deployment]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE</span><br><span class="line">dp-cfm-demo-8c4975c9b-54bvl   1/1     Running   0          14m   192.168.1.63   10.1.2.2    &lt;none&gt;</span><br><span class="line">dp-cfm-demo-8c4975c9b-jwrg7   1/1     Running   0          14m   192.168.2.90   10.1.2.15   &lt;none&gt;</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://192.168.1.63&lt;h&gt;&quot;Hello World!&quot;&lt;/h&gt;</span><br></pre></td></tr></table></figure>

<p>Secret本质上和ConfigMap是一样的，只是它的内容是加密的，用相同的文件创建一个secret，发现其内容用Base64编码了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/configmap]# kubectl create secret generic secret-demo --from-file=index.html </span><br><span class="line">secret/secret-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/configmap]# kubectl get secret secret-demo -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  index.html: PGg+IkhlbGxvIFdvcmxkISI8L2g+Cg==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h3 id="PV和PVC"><a href="#PV和PVC" class="headerlink" title="PV和PVC"></a>PV和PVC</h3><p>虽然kubernetes有<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/">Volumes</a>，但是Volumes要求Pod的开发者了解集群中可用的真实的网络存储组件，这与kubernetes的向开发人员隐藏真实的基础设施的理念不符，所以引入了<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PV与PVC</a>。</p>
<ul>
<li>PV，由管理创建（或动态创建）的一块存储区域，它规定了存储空间大小，访问模式和存储介质类型。</li>
<li>PVC，声明了需要使用的PV的最低容量要求和访问模式，在Pod中被使用。<br>创建一个PV，之后创建一个PVC会自动绑定满足条件的PV</li>
</ul>
<p>PV和PVC的yaml文件如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@VM_2_15_centos</span> <span class="string">~/macduan/demo/pv-pvc</span>]<span class="comment"># cat pv-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span> </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/root/macduan/demo/pv-pvc/tmp</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@VM_2_15_centos</span> <span class="string">~/macduan/demo/pv-pvc</span>]<span class="comment"># cat pvc-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建PV之后发现其状态是Available，在创建PVC之后发现该PV满足其条件并绑定了，所以pv-demo的状态变成了Bound。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl apply -f pv-demo.yaml </span><br><span class="line">persistentvolume/pv-demo created</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl get pv pv-demo</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv-demo   5Mi        RWO,ROX        Retain           Available                                   6s</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl apply -f pvc-demo.yaml </span><br><span class="line">persistentvolumeclaim/pvc-demo created</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl get pvc pvc-demo -o wide</span><br><span class="line">NAME       STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-demo   Bound    pv-demo   5Mi        RWO,ROX                       10s</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl get pv pv-demo -o wide</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM              STORAGECLASS   REASON   AGE</span><br><span class="line">pv-demo   5Mi        RWO,ROX        Retain           Bound    default/pvc-demo                           50s</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# cat pod-demo.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo </span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx </span><br><span class="line">    name: container-demo </span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: index</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">  - name: index</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: pvc-demo</span><br></pre></td></tr></table></figure>

<p>上面的PV使用hostPath模式，集群模式的kubernetes的PV不应该使用hostPath，因为不知道Pod会被调度到哪个节点上；这里为了demo方便所以使用hostPath模式，不过简单的workaround可以不影响demo；首先用上面的yaml文件创建一个Pod，发现它被调度到节点10.2.2.2上了，那么在该节点上创建目录PV的yaml文件中指定的hostPath<code>/root/macduan/demo/pv-pvc/tmp</code>，并创建一个index.html的文件，和上一节ConfigMap类似，PVC帮定的PV（pv-demo）挂载到nginx的<code>/usr/share/nginx/html</code>，其中的index.html被<code>/root/macduan/demo/pv-pvc/tmp/index.html</code>覆盖了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl apply -f pod-demo.yaml </span><br><span class="line">pod/pod-demo created</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl get pod pod-demo</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-demo   1/1     Running   0          6s</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl get pod pod-demo -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE       NOMINATED NODE</span><br><span class="line">pod-demo   1/1     Running   0          10s   192.168.1.64   10.1.2.2   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@VM_2_2_centos ~]# mkdir -p /root/macduan/demo/pv-pvc/tmp</span><br><span class="line">[root@VM_2_2_centos ~/macduan/demo/pv-pvc/tmp]# echo &#x27;&lt;h&gt;Hello World!&lt;/h&gt;&#x27; &gt; index.html</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/pv-pvc]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://192.168.1.64</span><br><span class="line">&lt;h&gt;Hello World!&lt;/h&gt;</span><br></pre></td></tr></table></figure>

<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>前面讲到的Deployment还是Service都只适用无状态应用，对于有状态的应用，客户端需要每次访问到特定的Pod，每个Pod需要使用固定的存储数据，即使在Pod可能被删除后被拉起调度到别的节点。这里参考了kubernetes官网的<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/">StatefulSet Basic</a>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Mi</span></span><br></pre></td></tr></table></figure>

<p>上面的yaml文件包含了Service和StatefuSet的manifest，需要注意的是，Service部分的spec.clusterIP为None，这是因为StatefulSet的控制Service必须是<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless模式</a>，在StatefulSet部分的sepc.volumeClaimTemplates是PVC的模板，创建该StatefulSet的Pod时，会自动为每个Pod分配一个PVC。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个StatefulSet服务</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl apply -f ss-demo.yaml </span><br><span class="line">service/nginx created</span><br><span class="line">statefulset.apps/web created</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl get svc nginx -o wide</span><br><span class="line">NAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">nginx   ClusterIP   None         &lt;none&gt;        80/TCP    6m44s   app=nginx</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl get statefulset -o wide</span><br><span class="line">NAME   DESIRED   CURRENT   AGE     CONTAINERS   IMAGES</span><br><span class="line">web    2         2         6m57s   nginx        nginx</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE</span><br><span class="line">web-0   1/1     Running   0          8m2s    192.168.2.93   10.1.2.15   &lt;none&gt;</span><br><span class="line">web-1   1/1     Running   0          7m28s   192.168.1.65   10.1.2.2    &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Each Pod has a stable hostname based on its ordinal index. Use kubectl <span class="built_in">exec</span> to execute the hostname <span class="built_in">command</span> <span class="keyword">in</span> each Pod.</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# for i in 0 1; do kubectl exec web-$i -- sh -c &#x27;hostname&#x27;; done</span><br><span class="line">web-0</span><br><span class="line">web-1</span><br></pre></td></tr></table></figure>

<p>上面会发现Pod的名字不再是随机的了，而是有固定编号了，而且每个Pod有固定的hostname。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过SRV记录发现该服务的两个Pod的FQDN</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl run -it srvlookup --image=tutum/dnsutils --rm --restart=Never -- dig SRV nginx.default.svc.cluster.local</span><br><span class="line">...</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">web-1.nginx.default.svc.cluster.local. 5 IN A   192.168.1.65</span><br><span class="line">web-0.nginx.default.svc.cluster.local. 5 IN A   192.168.0.90</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改每个Pod的index.html（挂载到PV上了）</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# for i in 0 1; do kubectl exec web-$i -- sh -c &#x27;echo $(hostname) &gt; /usr/share/nginx/html/index.html&#x27;; done</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://web-0.nginx</span><br><span class="line">web-0</span><br><span class="line">pod &quot;curlutils&quot; deleted</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://web-1.nginx</span><br><span class="line">web-1</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl delete pod web-0</span><br><span class="line">pod &quot;web-0&quot; deleted</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP             NODE       NOMINATED NODE</span><br><span class="line">web-0   1/1     Running   0          54s     192.168.0.90   10.1.2.6   &lt;none&gt;</span><br><span class="line">web-1   1/1     Running   0          3h42m   192.168.1.65   10.1.2.2   &lt;none&gt;</span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://web-0.nginx.default</span><br><span class="line">web-0</span><br></pre></td></tr></table></figure>

<p>从上面的操作可以看出，修改了每个Pod的<code>/usr/share/nginx/html/index.html</code>（通过PV挂载了）的内容后，给不同的Pod发送请求会收到不同的结果，即使删除了web-0，它被拉起后调度到10.1.2.6了，对它的请求返回还是之前写入的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改副本数量为3</span></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl apply -f ss-demo.yaml </span><br><span class="line">service/nginx unchanged</span><br><span class="line">statefulset.apps/web configured</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl get pod -l app=nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP              NODE        NOMINATED NODE</span><br><span class="line">web-0   1/1     Running   0          49m     192.168.0.90    10.1.2.6    &lt;none&gt;</span><br><span class="line">web-1   1/1     Running   0          4h30m   192.168.1.65    10.1.2.2    &lt;none&gt;</span><br><span class="line">web-2   1/1     Running   0          52s     192.168.2.104   10.1.2.15   &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@VM_2_15_centos ~/macduan/demo/statefulset]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://web-2.nginx.default</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.17.3&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>修改副本数量为3之后，一个新的Pod web-2被创建了，编号是从0开始递增的，由于这里的PV是<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Dynamic Provision</a>，内容是空的，所以向web-2发送的请求会出现上面的回复。</p>
<h2 id="服务改造指南"><a href="#服务改造指南" class="headerlink" title="服务改造指南"></a>服务改造指南</h2><h3 id="检索服务"><a href="#检索服务" class="headerlink" title="检索服务"></a>检索服务</h3><p>绝大部分的检索系统是包含基础召回服务和汇聚服务（一层或者两层），这里只讲如何改造基础召回服务，后面提到检索服务实际是指基础召回服务。简单讲检索服务的节点就是索引所在的节点，后面就叫qn（query node），它们接收请求根据索引数据返回检索结果，然后在汇聚层做聚合。由于索引数据往往很大，所以要做shard，为了保证可靠性也需要replica，抽象来看基础召回服务的拓扑结构就是一个N * M的矩阵，M列就是指shard数量，N行就是N份replica，每次检索请求会到所有的shard的某个replica上。检索服务，在Kubernetes上每个qn装在一个pod中，可以做成无状态的方式和有状态的方式:</p>
<p><strong>无状态服务</strong></p>
<p>每一列一个Deployment+Service，检索服务的每一列都是相同的索引，所以在每一列上是无状态的，这种方式比较简单，基本上就是参考操作指南章节的Deployment和Service部分就可以了。</p>
<p><strong>有状态服务</strong></p>
<p>每一行一个Statefulset+Service，检索服务每一行的每个qn之间的索引是不一样的，也就是有状态的索引需要用Statefulset。</p>
<p>这里假设检索服务拓扑结构是一个2*3的矩阵，所以需要两个Statefulset+Service，复用操作指南章节中的yaml，用nginx模拟qn假设其index.html是所以文件，代理层（聚合层）这里用简单的命令模拟。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">retrieve-01</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">retrieve-01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">qn-01</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">qn-01</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ss-01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;retrieve-01&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">qn-01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">qn-01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Mi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">retrieve-02</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">retrieve-02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">qn-02</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">qn-02</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ss-02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;retrieve-02&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">qn-02</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">qn-02</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Mi</span></span><br></pre></td></tr></table></figure>
<p>用上面的yaml文件创建两个有状态的服务，分布代表检索服务的两行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第一行</span></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it srvlookup --image=tutum/dnsutils --rm --restart=Never -- dig SRV retrieve-01.default.svc.cluster.local</span><br><span class="line">        ...</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">ss-01-0.retrieve-01.default.svc.cluster.local. 5 IN A 192.168.0.115</span><br><span class="line">ss-01-2.retrieve-01.default.svc.cluster.local. 5 IN A 192.168.1.101</span><br><span class="line">ss-01-1.retrieve-01.default.svc.cluster.local. 5 IN A 192.168.2.140</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二行</span></span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it srvlookup --image=tutum/dnsutils --rm --restart=Never -- dig SRV retrieve-02.default.svc.cluster.local</span><br><span class="line">        ...</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">ss-02-1.retrieve-02.default.svc.cluster.local. 5 IN A 192.168.1.104</span><br><span class="line">ss-02-2.retrieve-02.default.svc.cluster.local. 5 IN A 192.168.2.150</span><br><span class="line">ss-02-0.retrieve-02.default.svc.cluster.local. 5 IN A 192.168.0.120</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">上面创建的检索服务的拓扑结构如下</span><br><span class="line">ss-01-0     ss-01-1     ss-01-2  ---&gt; retrieve-01</span><br><span class="line">ss-02-0     ss-02-1     ss-02-2  ---&gt; retrieve-02</span><br><span class="line"></span><br><span class="line">用index.html模拟索引文件</span><br><span class="line">[root@VM_2_6_centos ~]# for i in 0 1 2;do kubectl exec ss-01-$i -- sh -c &quot;echo index-$i &gt; /usr/share/nginx/html/index.html&quot;;done</span><br><span class="line">[root@VM_2_6_centos ~]# for i in 0 1 2;do kubectl exec ss-02-$i -- sh -c &quot;echo index-$i &gt; /usr/share/nginx/html/index.html&quot;;done</span><br><span class="line"></span><br><span class="line">cur请求模拟检索请求，在某一行的服务中，可以指定到具体的qn进行检索（一般是所有的）</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://ss-01-0.retrieve-01</span><br><span class="line">index-0</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://ss-01-2.retrieve-01</span><br><span class="line">index-2</span><br><span class="line">[root@VM_2_6_centos ~]# kubectl run -it curlutils --image=tutum/curl --generator=run-pod/v1 --rm --restart=Never -- curl http://ss-02-0.retrieve-02</span><br><span class="line">index-0</span><br></pre></td></tr></table></figure>

  </div>
</article>

        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/technology">Technology</a></li>
         
          <li><a href="/categories/life">Life</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">Kubernetes简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.</span> <span class="toc-text">kubernetes是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.</span> <span class="toc-text">kubernetes提供了什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E4%B8%8D%E6%8F%90%E4%BE%9B%E4%BB%80%E4%B9%88"><span class="toc-number">2.3.</span> <span class="toc-text">kubernetes不提供什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">kubernetes对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.1.</span> <span class="toc-text">基础对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E5%AF%B9%E8%B1%A1%EF%BC%88%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">2.4.2.</span> <span class="toc-text">高级对象（控制器）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%B5%81%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">架构与流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97"><span class="toc-number">3.</span> <span class="toc-text">操作指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">3.1.</span> <span class="toc-text">Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-restartPolicy"><span class="toc-number">3.1.1.</span> <span class="toc-text">Container restartPolicy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-Probes"><span class="toc-number">3.1.2.</span> <span class="toc-text">Container Probes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReplicaSet"><span class="toc-number">3.2.</span> <span class="toc-text">ReplicaSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DaemonSet"><span class="toc-number">3.3.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment"><span class="toc-number">3.4.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">3.5.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%BB%99%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.5.1.</span> <span class="toc-text">服务暴露给集群内部客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">服务发现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2%E7%BB%99%E9%9B%86%E7%BE%A4%E5%A4%96%E9%83%A8%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.5.2.</span> <span class="toc-text">服务暴露给集群外部客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap%E5%92%8CSecret"><span class="toc-number">3.6.</span> <span class="toc-text">ConfigMap和Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PV%E5%92%8CPVC"><span class="toc-number">3.7.</span> <span class="toc-text">PV和PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet"><span class="toc-number">3.8.</span> <span class="toc-text">StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%94%B9%E9%80%A0%E6%8C%87%E5%8D%97"><span class="toc-number">4.</span> <span class="toc-text">服务改造指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">检索服务</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/11/08/byte-of-kubernetes/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/11/08/byte-of-kubernetes/&text=简明Kubernetes教程"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/11/08/byte-of-kubernetes/&is_video=false&description=简明Kubernetes教程"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=简明Kubernetes教程&body=Check out this article: http://example.com/2018/11/08/byte-of-kubernetes/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/11/08/byte-of-kubernetes/&title=简明Kubernetes教程"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/11/08/byte-of-kubernetes/&name=简明Kubernetes教程&description=&lt;h2 id=&#34;前言&#34;&gt;&lt;a href=&#34;#前言&#34; class=&#34;headerlink&#34; title=&#34;前言&#34;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;该文档假定大家有一定的Docker基础，介绍了kubernetes的常用和重要的功能的简单使用方法，目的是为了让大家看完可以快速上手kubernetes，并且在遇到问题时或者想深入了解某方面的时候知道如何Google；该文档主要参考了&lt;a href=&#34;https://kubernetes.io/docs/home/&#34;&gt;https://kubernetes.io/docs/home/&lt;/a&gt; 和 &lt;a href=&#34;https://item.jd.com/12510666.html&#34;&gt;Kubernetes In Action&lt;/a&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/11/08/byte-of-kubernetes/&t=简明Kubernetes教程"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2023
    duanmeng
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/technology">Technology</a></li><!--
     --><!--
       --><li><a href="/categories/life">Life</a></li><!--
     --><!--
       --><li><a href="/archives/">Archives</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>



  <script src='https://unpkg.com/mermaid@9.0.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
