<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="What is VeloxVelox是Meta开发的扩展性强，高性能的C++执行引擎加速库，用于Meta内部的批处理，流处理，交互式查询，和机器学习组件（Presto, Spark, PyTorch, XStream, F3, FBETL等）。Velox不提供语言前端，比如SQL，Dataframe等，它使用一个充分优化后的查询计划作为输入，然后使用local host的资源执行。Velox虽然">
<meta property="og:type" content="article">
<meta property="og:title" content="Velox: Meta’s Unified Execution Engine">
<meta property="og:url" content="http://example.com/2022/12/03/velox-depp-intro/index.html">
<meta property="og:site_name" content="Macduan Notes">
<meta property="og:description" content="What is VeloxVelox是Meta开发的扩展性强，高性能的C++执行引擎加速库，用于Meta内部的批处理，流处理，交互式查询，和机器学习组件（Presto, Spark, PyTorch, XStream, F3, FBETL等）。Velox不提供语言前端，比如SQL，Dataframe等，它使用一个充分优化后的查询计划作为输入，然后使用local host的资源执行。Velox虽然">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://velox-lib.io/img/stack_transform.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/flat-vector.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/array-out-of-order.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/string-vector.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/row-vector.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/expression-evaluation.png">
<meta property="og:image" content="https://velox-lib.io/img/simple1_1.png">
<meta property="og:image" content="https://facebookincubator.github.io/velox/_images/task-join-plan.png">
<meta property="article:published_time" content="2022-12-03T07:47:49.000Z">
<meta property="article:modified_time" content="2023-04-01T01:17:30.446Z">
<meta property="article:author" content="duanmeng">
<meta property="article:tag" content="data">
<meta property="article:tag" content="paper">
<meta property="article:tag" content="velox">
<meta property="article:tag" content="QueryExecution">
<meta property="article:tag" content="SIMD">
<meta property="article:tag" content="vectorized">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://velox-lib.io/img/stack_transform.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Velox: Meta’s Unified Execution Engine</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/archives/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/technology">Technology</a></li><!--
     --><!--
       --><li><a href="/categories/life">Life</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/12/06/macduan-velox-commits/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/11/photon/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/12/03/velox-depp-intro/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/12/03/velox-depp-intro/&text=Velox: Meta’s Unified Execution Engine"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/12/03/velox-depp-intro/&is_video=false&description=Velox: Meta’s Unified Execution Engine"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Velox: Meta’s Unified Execution Engine&body=Check out this article: http://example.com/2022/12/03/velox-depp-intro/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/12/03/velox-depp-intro/&name=Velox: Meta’s Unified Execution Engine&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/12/03/velox-depp-intro/&t=Velox: Meta’s Unified Execution Engine"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-Velox"><span class="toc-number">1.</span> <span class="toc-text">What is Velox</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-Velox"><span class="toc-number"></span> <span class="toc-text">Why Velox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Velox-Structure"><span class="toc-number"></span> <span class="toc-text">Velox Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Velox-Deep-Dive"><span class="toc-number"></span> <span class="toc-text">Velox Deep Dive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Type"><span class="toc-number">1.</span> <span class="toc-text">Type</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Scalar-Type"><span class="toc-number">1.1.</span> <span class="toc-text">Scalar Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Complex-Type"><span class="toc-number">1.2.</span> <span class="toc-text">Complex Type</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vector"><span class="toc-number">2.</span> <span class="toc-text">Vector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expression"><span class="toc-number">3.</span> <span class="toc-text">Expression</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Compilation"><span class="toc-number">3.1.</span> <span class="toc-text">Compilation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Evaluation"><span class="toc-number">3.2.</span> <span class="toc-text">Evaluation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Function"><span class="toc-number">4.</span> <span class="toc-text">Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Operators"><span class="toc-number">5.</span> <span class="toc-text">Operators</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Task"><span class="toc-number">5.1.</span> <span class="toc-text">Task</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">参考</span></a>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Velox: Meta’s Unified Execution Engine
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">duanmeng</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-12-03T07:47:49.000Z" itemprop="datePublished">2022-12-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/technology/">technology</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/QueryExecution/" rel="tag">QueryExecution</a>, <a class="tag-link-link" href="/tags/SIMD/" rel="tag">SIMD</a>, <a class="tag-link-link" href="/tags/data/" rel="tag">data</a>, <a class="tag-link-link" href="/tags/paper/" rel="tag">paper</a>, <a class="tag-link-link" href="/tags/vectorized/" rel="tag">vectorized</a>, <a class="tag-link-link" href="/tags/velox/" rel="tag">velox</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://velox-lib.io/img/stack_transform.png" alt="image"></p>
<h3 id="What-is-Velox"><a href="#What-is-Velox" class="headerlink" title="What is Velox"></a>What is Velox</h3><p>Velox是Meta开发的扩展性强，高性能的C++执行引擎加速库，用于Meta内部的批处理，流处理，交互式查询，和机器学习组件（Presto, Spark, PyTorch, XStream, F3, FBETL等）。Velox不提供语言前端，比如SQL，Dataframe等，它使用一个充分优化后的查询计划作为输入，然后使用local host的资源执行。Velox虽然不提供全局优化器，但是它执行时应用了大量的自适应（adaptive）技术，比如filter，conjunct reordering, dynamic filter pushdown和adaptive column prefetching等，总而言之它主要关注数据面（data-plane），上层引擎（Presto，Spark等）主要负责控制面（control-plane）。</p>
<h2 id="Why-Velox"><a href="#Why-Velox" class="headerlink" title="Why Velox"></a>Why Velox</h2><p>前面提到Velox被用在Meta内部的各个不同的引擎，虽然它们在前端语言（SQL，dataframe等），优化器，分布式任务调度等方面都不完全相同，但是在执行引擎（execution engine）层面大致相同的，都需要一个类型系统来表达scalar和complex数据类型，一个内存数据集表示（基本都是columnar，类似的有<a target="_blank" rel="noopener" href="https://arrow.apache.org/">Arrow</a>），一个表达式解析系统（expression evaluation)，算子（Operator，比如joins，aggregation，sort等），此外还有存储，网络，序列化，编码格式和资源管理等。</p>
<h2 id="Velox-Structure"><a href="#Velox-Structure" class="headerlink" title="Velox Structure"></a>Velox Structure</h2><ul>
<li><p>Type<br>通用类型系统，允许用户表示标量（Scalar）、复杂（Complex）和嵌套数据类型，包括struct，map，array，tensor等。</p>
</li>
<li><p>Vector<br><a target="_blank" rel="noopener" href="https://arrow.apache.org/">Arrow</a>-compatible列式内存布局模块，支持多种编码，包括Flat，Dictionary，Constant，Sequence&#x2F;RLE, and Bias等，还支持延迟物化，乱序写入。</p>
</li>
<li><p>Expression Eval<br>基于矢量编码（Vector-encoded）数据构建的，完全向量化的表达式求值引擎（expression evaluation engine），它借助了common subexpression elimination，constant folding，effective null propagation，encoding-aware evaluation和dictionary memoization等技术。</p>
</li>
<li><p>Functions<br>Velox函数库提供了与流行的 SQL 方言兼容的函数包（目前，用于 Presto 和 Spark），还提供了简单（row-by-row）和矢量化（batch-by-batch），聚合函数API，让开发人员构建自定义函数。这里论文没细说，虽然简单函数提供row-by-row的写法，最终还是向量化执行的，通过<a target="_blank" rel="noopener" href="https://velox-lib.io/img/simple1_1.png">SimpleFunctionAdapter</a>转换成向量函数，后面写一篇文章专门介绍。</p>
</li>
<li><p>Operator<br>实现了常用的数据处理的算子，包括TableScan，Project，Filter，Aggregation，Exchange&#x2F;Merge，OrderBy，HashJoin，MergeJoin，Unnest等。</p>
</li>
<li><p>I&#x2F;O<br>通用的connector interface，允许可插拔文件格式编码器&#x2F;解码器和存储适配器。支持常见的格式，例如ORC，Parquet，以及 S3，HDFS等存储系统。</p>
</li>
<li><p>Serializers<br>网络通信的序列化接口，可以实现不同的有线协议，支持PrestoPage和Spark的UnsafeRow 格式。</p>
</li>
<li><p>Resource Management<br>用于处理计算资源的原语集合，例如内存区域（memory arenas），缓冲区管理（buffer managment），tasks，drivers（这里的driver指velox的pipeline的driver，非spark driver），线程池，spilling和cache。</p>
</li>
</ul>
<h2 id="Velox-Deep-Dive"><a href="#Velox-Deep-Dive" class="headerlink" title="Velox Deep Dive"></a>Velox Deep Dive</h2><h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p><a target="_blank" rel="noopener" href="https://facebookincubator.github.io/velox/develop/types.html">Velox支持标量类型和复杂类型，覆盖了基本上所有Presto和Spark的数据类型</a></p>
<h4 id="Scalar-Type"><a href="#Scalar-Type" class="headerlink" title="Scalar Type"></a>Scalar Type</h4><p>Velox中的标量类型是逻辑的并且与SQL兼容。每个标量类型都是使用C++类型实现的。下表显示了支持的标量类型及其对应的 C++ 类型。</p>
<table>
<thead>
<tr>
<th align="left">Velox Type</th>
<th align="left">C++ Type</th>
<th align="left">Bytes per Value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BOOLEAN</td>
<td align="left">bool</td>
<td align="left">0.125 (i.e. 1 bit)</td>
</tr>
<tr>
<td align="left">TINYINT</td>
<td align="left">int8_t</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">SMALLINT</td>
<td align="left">int16_t</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">INTEGER</td>
<td align="left">int32_t</td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">BIGINT</td>
<td align="left">int64_t</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">DATE</td>
<td align="left">struct Date</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">REAL</td>
<td align="left">float</td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">DOUBLE</td>
<td align="left">double</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">SHORT_DECIMAL</td>
<td align="left">struct UnscaledShortDecimal</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">LONG_DECIMAL</td>
<td align="left">struct UnscaledLongDecimal</td>
<td align="left">16</td>
</tr>
<tr>
<td align="left">TIMESTAMP</td>
<td align="left">struct Timestamp</td>
<td align="left">16</td>
</tr>
<tr>
<td align="left">INTERVAL DAY TO SECOND</td>
<td align="left">struct IntervalDayTime</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">VARCHAR</td>
<td align="left">struct StringView</td>
<td align="left">16</td>
</tr>
<tr>
<td align="left">VARBINARY</td>
<td align="left">struct StringView</td>
<td align="left">16</td>
</tr>
</tbody></table>
<h4 id="Complex-Type"><a href="#Complex-Type" class="headerlink" title="Complex Type"></a>Complex Type</h4><p>Velox还支持复杂类型，包括arrays，fixed-size arrays（用在ML tensor），maps，rows&#x2F;structus；所有这些类型都可以任意嵌套并提供序列化&#x2F;反序列化方法。</p>
<h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><p>Velox vector对scalar type和complex type的物理布局本质是一样的，都包含一个value buffer连续存放实际的value，null buffer标识value是否为null，比如下面的FlatVector<int32_t>与ArrayVector。</p>
<table><tr>
<td><img src="https://facebookincubator.github.io/velox/_images/flat-vector.png" width="320" height="242" alt="flat-verctor"></td>
<td><img src="https://facebookincubator.github.io/velox/_images/array-out-of-order.png" width="400" height="302" alt="array-vector"></td>
</tr></table>

<p><a><img src="https://facebookincubator.github.io/velox/_images/string-vector.png" width="1024" height="640" alt="stringvector"></a><br><a><img src="https://facebookincubator.github.io/velox/_images/row-vector.png" width="800" height="580" alt="row-vector"></a></p>
<p>前面提到Vector支持乱序写入，zero-copy，是因为vector的value buffer的item都固定长度。即使是string类型的元素也是固定12字节，如果字符串长度超过12就会转化成一个4字节对prefix和一个8字节的指针指向一个stringBuffer，对于substr(s, 2)只需要移动data指针即可，不需要做拷贝。详细请见<a target="_blank" rel="noopener" href="https://facebookincubator.github.io/velox/develop/vectors.html">开发者文档</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">strcut StringView &#123;</span><br><span class="line">    uint32_t size_;</span><br><span class="line">    char prefix_[4];</span><br><span class="line">    union &#123;</span><br><span class="line">        char inlined[8];</span><br><span class="line">        const char* data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h3><p>Velox的expression evaluation引擎可以被用在3种场景：</p>
<ol>
<li>FilterProject算子中过滤（filter）与投影（project）的表达式求值</li>
<li>TableScan算子和IO connectors一致性求值谓词下推（consistently evaluate predicate<br>pushdown，<strong>这里的consistently我理解是指下推不影响计算结果</strong>）</li>
<li>独立的组件给只需要表达式求值功能的引擎，比如实时计算，ML场景的数据预处理</li>
</ol>
<p>表达式求值的输入表达式树，有以下几种节点：</p>
<ul>
<li>a reference to an input column，代表一个input RowVector的列（比如，C0），必定是叶子节点</li>
<li>a constant (or literal)，必定是叶子节点</li>
<li>a function call，比如<a target="_blank" rel="noopener" href="https://github.com/facebookincubator/velox/commit/5f7e2bc41fb6406bbd3117ea6a2f6a1089524a71">array_has_duplicates</a>, <a target="_blank" rel="noopener" href="https://github.com/facebookincubator/velox/commit/8f64992fc136a05c6054ee1d27e2d6716b80a084">hmac_sha256</a>，还有类似AND&#x2F;OR，IF&#x2F;SWITCH，try这样的</li>
<li>a CAST expression</li>
<li>a lambda function，比<code>(x, y) -&gt; x + y</code></li>
</ul>
<p>表达式树节点还包含以下两类元数据</p>
<ul>
<li>子表达式是否具有确定性，即相同的输入产出相同的结果</li>
<li>null传播，任何一个输入列的value为null是否总是让该表达式结果为null</li>
</ul>
<p>表达式求值（Expression Evaluation）分为两阶段，Compilation &amp; Evaluation。</p>
<h4 id="Compilation"><a href="#Compilation" class="headerlink" title="Compilation"></a>Compilation</h4><p>将expression tree作为输入，编译成可执行的expression（Compiled Expression &#x2F; Executable Expression）</p>
<ul>
<li>Common Subexpression Elimination<br>比如<code>strpos(upper (a), ‘FOO’) &gt; 0 OR strpos(upper(a), ‘BAR’) &gt; 0</code>中的<code>upper(a)</code>只计算一次即可</li>
<li>Constant Folding<br>比如<code>upper(a) &gt; upper(‘Foo’)</code>中<code>upper(‘Foo’)</code>是确定的，不依赖任何输入列，可以直接转成<code>‘FOO’</code></li>
<li>Adaptive Conjunct Reordering<br>比如<code>AND(AND(AND(a, b), c), AND(d, e))</code>打平成<code>AND(a, b, c, d, e)</code></li>
</ul>
<h4 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h4><p>将可执行的expression和input dataset计算结果，返回output dataset。这个过程包括递归下降处理expression tree，向下传递一个行掩码（row mask）标识有效的行。每个步骤都会避免重复计算</p>
<ul>
<li>common subexpression</li>
<li>nulls传递expression，且有输入为null<br>Evaluation还包括如下两类优化</li>
<li>Peeling<br>只计算distinct值，比如<code>upper(color)</code>，color列是一个字典编码，1000个indices和3个元素[red, green, blue]的inner vector，只需将upper函数apply到这3元素即可，产出一个[RED, GREEN, BLUE]的inner vector，复用之前的1000个indices即可产出结果。</li>
<li>Memoization<br>对于字典编码的输入，有可能只是indices不同，underlying inner vector是相同的（比如都是[red, green, blue]），记录和复用对inner vector的计算结果。</li>
</ul>
<p>Velox的开发者文档对<a target="_blank" rel="noopener" href="https://facebookincubator.github.io/velox/develop/expression-evaluation.html">Expression的优化描述</a>更详细，可以对照看一下。<br><img src="https://facebookincubator.github.io/velox/_images/expression-evaluation.png" alt="image"></p>
<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>Velox提供了API让开发者定制（主要是velox社区实现各类prestosql或者sparksql的functions，aggregate functions），scalar functions和aggregate functions。作为一个向量化引擎，Velox的scalar function API可以是向量化的，即输入参数是batch-by-batch的vectors，还包括 nullability buffers，active rows（bitmap），并可以利用vectors内置的null buffer，length buffer和key buffer等实现常量时间复杂度的is_null(), cardinality()和keys()等操作。</p>
<p>Velox还提供了一个<a target="_blank" rel="noopener" href="https://velox-lib.io/blog/simple-functions-1">Simple Function Framework</a>，让开发者只需要用传统的按行处理的scalar function的方式开发，框架会利用元编程，编译器hint方式等转成向量化实现。该框架不仅屏蔽了vector解码的细节，还直接映射了所有的primitive类型到对应的C++类型，对于一些非primitive类型，比如<code>std::string</code>, <code>std::vector</code>则是通过代理对象和<code>ArrayReader/ArrayWriter</code>这样的API直接操作vector的底层数据，而不做额外的allocation或者拷贝。此外对字符串的处理，velox提供了ASCII-only这样的fast path来加速，详细可以看这个<a target="_blank" rel="noopener" href="https://velox-lib.io/blog/simple-functions-1">官方博客</a>。</p>
<p><a><img src="https://velox-lib.io/img/simple1_1.png" width="800" height="580" alt="simple-func"></a></p>
<h3 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h3><p>Velox的查询计划是一个PlanNode Tree，执行一个query的时候会把nodes转成operators，大多数情况是一对一转换，有些特殊情况，比如Filter和随后的Project Node会被合成一个FilterProject operator，HashJoin Node会被分成HashProbe于HashBuild opertors，详细转换参见<a target="_blank" rel="noopener" href="https://facebookincubator.github.io/velox/develop/operators.html">这里</a>。</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>Velox执行的顶层抽象就是<strong>Task</strong>，它是实际分布式执行的功能单元，对应query plan的一个片段及其operator tree（类似Presto中的stage的逻辑概念），一个task开始于一个TableScan或者一个Exchange（Shuffle）作为其输入，结束于另一个Exchange。每个Task可以分成多个Pipelines，比如HashProbe于HashBuild对应不同的pipeline。Velox的pipeline可以并行执行，每个并行实例对应一个Driver，每个driver都有自己的状态，可以在应用层切换（比如消费的数据还未ready）。<br><a><img src="https://facebookincubator.github.io/velox/_images/task-join-plan.png" width="640" height="302" alt="plan"></a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://engineering.fb.com/2022/08/31/open-source/velox/">https://engineering.fb.com/2022/08/31/open-source/velox/</a></li>
<li><a target="_blank" rel="noopener" href="https://vldb.org/pvldb/vol15/p3372-pedreira.pdf">https://vldb.org/pvldb/vol15/p3372-pedreira.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://velox-lib.io/blog">https://velox-lib.io/blog</a></li>
<li><a target="_blank" rel="noopener" href="https://facebookincubator.github.io/velox/develop.html">https://facebookincubator.github.io/velox/develop.html</a></li>
<li><a target="_blank" rel="noopener" href="https://arrow.apache.org/">https://arrow.apache.org/</a></li>
</ul>

  </div>
</article>

        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/archives/">Home</a></li>
         
          <li><a href="/categories/technology">Technology</a></li>
         
          <li><a href="/categories/life">Life</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-Velox"><span class="toc-number">1.</span> <span class="toc-text">What is Velox</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-Velox"><span class="toc-number"></span> <span class="toc-text">Why Velox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Velox-Structure"><span class="toc-number"></span> <span class="toc-text">Velox Structure</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Velox-Deep-Dive"><span class="toc-number"></span> <span class="toc-text">Velox Deep Dive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Type"><span class="toc-number">1.</span> <span class="toc-text">Type</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Scalar-Type"><span class="toc-number">1.1.</span> <span class="toc-text">Scalar Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Complex-Type"><span class="toc-number">1.2.</span> <span class="toc-text">Complex Type</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vector"><span class="toc-number">2.</span> <span class="toc-text">Vector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expression"><span class="toc-number">3.</span> <span class="toc-text">Expression</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Compilation"><span class="toc-number">3.1.</span> <span class="toc-text">Compilation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Evaluation"><span class="toc-number">3.2.</span> <span class="toc-text">Evaluation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Function"><span class="toc-number">4.</span> <span class="toc-text">Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Operators"><span class="toc-number">5.</span> <span class="toc-text">Operators</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Task"><span class="toc-number">5.1.</span> <span class="toc-text">Task</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">参考</span></a>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/12/03/velox-depp-intro/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/12/03/velox-depp-intro/&text=Velox: Meta’s Unified Execution Engine"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/12/03/velox-depp-intro/&is_video=false&description=Velox: Meta’s Unified Execution Engine"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Velox: Meta’s Unified Execution Engine&body=Check out this article: http://example.com/2022/12/03/velox-depp-intro/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/12/03/velox-depp-intro/&title=Velox: Meta’s Unified Execution Engine"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/12/03/velox-depp-intro/&name=Velox: Meta’s Unified Execution Engine&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/12/03/velox-depp-intro/&t=Velox: Meta’s Unified Execution Engine"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2023
    duanmeng
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/archives/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/technology">Technology</a></li><!--
     --><!--
       --><li><a href="/categories/life">Life</a></li><!--
     --><!--
       --><li><a href="/tags/">Tags</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>



  <script src='https://unpkg.com/mermaid@9.0.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
